<loader-spinner-full-screen *ngIf="loaderFullScreen"></loader-spinner-full-screen>
<loader-spinner-navbar *ngIf="loaderNavbar"></loader-spinner-navbar>
<app-header appTitle="Pre-Registro">
  <button type="button" (click)="onCancel()" [disabled]="submittingForm">
    Cancelar
  </button>
  <button type="button" (click)="onSubmit()" [disabled]="!form.valid || submittingForm">
    Guardar
  </button>
</app-header>
<app-body [breadCrumbTree]="breadCrumbTree" [show]="!loaderFullScreen">
  <div class="row justify-content-center">
    <div class="col-6">
      <form [formGroup]="form" autocomplete="off">
        <div class="form-row">
          <div class="form-group col">

          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-3">
            <label for="nit">CI</label>
            <input type="text" class="form-control" id="ci" formControlName="ci" (input)="onInput()"
              [ngClass]="onFieldError('ci') + ' ' + onFieldRequired('ci')">
            <invalid-form-control [show]="onFieldInvalid('ci') == 'required'"
              message="NIT inválido."></invalid-form-control>
          </div>
          <div class="form-group col-md-3">
            <label for="nit">NIT</label>
            <input type="text" class="form-control" id="nit" formControlName="nit" (input)="onInput()"
              [ngClass]="onFieldError('nit') + ' ' + onFieldRequired('nit')">
            <invalid-form-control [show]="onFieldInvalid('nit') == 'required'"
              message="NIT inválido."></invalid-form-control>
          </div>
          <div class="form-group col-md-3">
            <label for="tipopessoa">Tipo de persona</label>
            <select class="form-control" id="tipopessoa" formControlName="tipopessoa" (change)="onInput()">
              <option value="S">Sociedades</option>
              <option value="P">Privado</option>
              <option value="G">Gobierno</option>
              <option value="E">Empleado</option>
            </select>
          </div>
          <div class="form-group col-md-3">
            <label for="vendedor"> Vendedor</label>
            <ng-select [searchable]="true" [clearable]="false" [items]="vendedores" [virtualScroll]="true"
              labelForId="vendedor" bindLabel="nombre" bindValue="ID" formControlName="vendedor"
              (change)="changeVendedor($event.ID)">
            </ng-select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="nome">Nombre completo</label>
            <input type="text" class="form-control" id="nome" formControlName="nome" (input)="onInput()"
              [ngClass]="onFieldError('nome') + ' ' + onFieldRequired('nome')">
            <invalid-form-control [show]="onFieldInvalid('nome') == 'required'"
              message="Nombre es obligatorio."></invalid-form-control>
            <invalid-form-control [show]="onFieldInvalid('nome') == 'maxlength'"
              [message]="maxLengthMessages.nome"></invalid-form-control>
          </div>
          <div class="form-group col-md-6">
            <label for="nomeFantasia">Nombre Factura</label>
            <input type="text" class="form-control" id="nombre_factura" formControlName="nombre_factura"
              (input)="onInput()" [ngClass]="onFieldError('nomeFantasia') + ' ' + onFieldRequired('nomeFantasia')">
          </div>
          <div class="form-group col-md-6">
            <label for="razaoSocial">Razon social</label>
            <input type="text" class="form-control" id="razaoSocial" formControlName="razaoSocial" (input)="onInput()"
              [ngClass]="onFieldError('razaoSocial') + ' ' + onFieldRequired('razaoSocial')">
            <invalid-form-control [show]="onFieldInvalid('razaoSocial') == 'required'"
              message="Razon social es obligatorio."></invalid-form-control>
            <invalid-form-control [show]="onFieldInvalid('razaoSocial') == 'maxlength'"
              [message]="maxLengthMessages.razaoSocial"></invalid-form-control>
          </div>
          <!--  <div class="form-group col-md-6">
            <label for="nomeFantasia">Nombre de Fantasia</label>
            <input type="text" class="form-control" id="nomeFantasia" formControlName="nomeFantasia" (input)="onInput()"
              [ngClass]="onFieldError('nomeFantasia') + ' ' + onFieldRequired('nomeFantasia')">
          </div> -->
          <div class="form-group col-md-6">
            <label for="celular">Celular</label>
            <input type="number" class="form-control" id="celular" formControlName="celular" (input)="onInput()"
              [ngClass]="onFieldError('celular') + ' ' + onFieldRequired('celular')">
            <invalid-form-control [show]="onFieldInvalid('celular') == 'required'"
              message="celular es obligatorio."></invalid-form-control>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="email">E-mail</label>
            <input type="email" class="form-control" id="email" formControlName="email" (input)="onInput()"
              [ngClass]="onFieldError('email') + ' ' + onFieldRequired('email')">
            <invalid-form-control [show]="onFieldInvalid('email') == 'required'"
              message="E-mail es obligatorio."></invalid-form-control>
            <invalid-form-control [show]="onFieldInvalid('email') == 'maxlength'"
              [message]="maxLengthMessages.email"></invalid-form-control>
          </div>
          <div class="form-group col-md-6">
            <label for="telefone">Telefono</label>
            <input type="number" class="form-control" id="telefone" formControlName="telefone" (input)="onInput()"
              [ngClass]="onFieldError('telefone') + ' ' + onFieldRequired('telefone')">
            <invalid-form-control [show]="onFieldInvalid('telefone') == 'required'"
              message="Telefono es obligatorio."></invalid-form-control>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-9">
            <label for="cnae">Rubro (Actividad Economica)</label>
            <ng-select [searchable]="true" [clearable]="false" [items]="cnaes" [virtualScroll]="true" labelForId="cnae"
              bindLabel="descripcion" bindValue="id_cnae" formControlName="cnae" (change)="onInput()"
              [ngClass]="onFieldError('cnae') + ' ' + onFieldRequired('cnae')">
            </ng-select>
            <invalid-form-control [show]="onFieldInvalid('cnae') == 'required'"
              message="CNAE es obligatorio."></invalid-form-control>
          </div>
          <div class="form-group col-md-3">
            <label for="cnae">Tipo de cliente</label>
            <!-- <ng-select [searchable]="true" [clearable]="false" [items]="tipos_clientes" [virtualScroll]="true"
              labelForId="cnae" bindLabel="nombre_tipo" bindValue="id" formControlName="tipo_cliente"
              [ngClass]="onFieldError('tipo_cliente') + ' ' + onFieldRequired('tipo_cliente')"
              [disabled]="this.disabled_form">
            </ng-select> -->
            <input type="text" value="REGULAR" class="form-control" disabled>
            <invalid-form-control [show]="onFieldInvalid('cnae') == 'required'"
              message="CNAE es obligatorio."></invalid-form-control>
          </div>
        </div>
        <!-- <div class="form-row">
          <div class="form-group col">
            <label for="cnae">Mapa</label>
            <div class="embed-responsive embed-responsive-16by9">
              <agm-map (mapClick)="actualizarMapa($event)" [latitude]="latitud" [longitude]="longitud" [zoom]="16"
                class="embed-responsive-item">
                <agm-marker *ngFor="let ubicacion of ubicaciones; let i = index" [latitude]="ubicacion.latitud"
                  [longitude]="ubicacion.longitud" (markerClick)="actualizarMarcador(i)" [iconUrl]="ubicacion.color"
                  (markerDragEnd)="actualizarUbicacion(i, $event.coords.lat, $event.coords.lng)">
                </agm-marker>
              </agm-map>
              <div id="map-zoom-control" class="map-control"></div>
            </div>
          </div>
        </div> -->
        <div class="form-row mt-2">
          <div class="col-md-3">
            <button data-toggle="collapse" data-target="#CollapseUbicacion" class="btn btn-primary"
              id="btnAgregarUbicacion" (click)="repetirFormulario('Ubicacion')"> <i class="fas fa-plus"></i>
              Agregar Ubicación</button>

          </div>
          <div class="col-md-3">
            <button data-toggle="collapse" data-target="#CollapseContacto" class="btn btn-success"
              id="btnAgregarContacto" (click)="repetirFormulario('Contacto')"> <i class="fas fa-plus"></i>
              Agregar Contacto</button>
          </div>
        </div>
        <div id="ContenedorFormularios" style="max-height: 700px; overflow-y: auto;" class="col-md-12">
          <div class="alert alert-warning mt-3" *ngIf="ubicacionFormularios.length > 0"> <strong> La primera ubicación
              se tomará como la principal </strong> </div>
          <div id="Ubicacion" *ngFor="let ubicacionForm of ubicacionFormularios; let i = index">
            <div id="CollapseUbicacion" [class.collapse]="!ubicacionCollapse">
              <div class="mt-3"></div>
              <div class="row "
                style="border-radius: 13px; background-color: rgb(246, 243, 243);  border: 1px solid #007BFF;">
                <div class="form-group col-md-12 mt-2" align="right">
                  <button class="btn btn-danger btn-sm" (click)="eliminarContacto(i, 2)" style="text-decoration: none">
                    X
                  </button>
                </div>
                <div class="form-group col-md-9 mt-1">
                  <label for="titulo_ubicacion">Nombre de ubicacion</label>
                  <input type="text" class="form-control" id="titulo_ubicacion" formControlName="titulo_ubicacion"
                    (input)="onInput()" [value]="ubicacionForm.ubicacion"
                    (ngModelChange)="actualizarPosicion($event, i)">
                </div>
                <div class="form-group col-md-3">
                  <label for="ciudadUbi">Ciudad</label>
                  <ng-select [searchable]="true" [clearable]="false" [items]="ciudades" [virtualScroll]="true"
                    (change)="cambiarCiudad($event.id, i)" labelForId="ciudad" bindLabel="nombre_ciudad" bindValue="id"
                    formControlName="nombre_ciudad"
                    [ngClass]="onFieldError('nombre_ciudad') + ' ' + onFieldRequired('nombre_ciudad')">
                    <ng-option *ngFor="let ciudad of ciudades"
                      [value]="ubicacionForm.ciudad_id !== 0 ? ubicacionForm.ciudad_id : ciudad_vendedor"
                      [disabled]="ciudad.id !== ciudad_vendedor">
                      {{ ciudad.nombre_ciudad }}
                    </ng-option>

                  </ng-select>

                </div>
                <div class="form-group col-md-12 " >
                  <label for="direccion">Direccion</label>
                  <input type="text" class="form-control" id="direccion" formControlName="" (input)="onInput()"
                    [(ngModel)]="ubicacionForm.direccion" [value]="ubicacionForm.direccion">
                </div>
                <div class="form-group col-md-12 text-center" *ngIf="ubicacionForm.swActivarLatitud === false">
                  <label for="direccion">Dirección </label> <br>
                  <button class="btn btn-primary" (click)="openModalUbicacion(seleccionarDireccion, i, 2)" > 
                    Agregar Dirección </button>
                </div>
                <div class="form-group col-md-3" *ngIf="ubicacionForm.swActivarLatitud === true">
                  <label for="ciudadUbi">Latitud</label>
                  <input type="text" class="form-control" id="titulo_ubicacion" formControlName="latitud"
                    (input)="onInput()" [(ngModel)]="ubicacionForm.latitud" [value]="ubicacionForm.latitud"
                    [readonly]="true">


                </div>
                <div class="form-group col-md-3" *ngIf="ubicacionForm.swActivarLatitud === true">
                  <label for="ciudadUbi">Longitud</label>
                  <input type="text" class="form-control" id="titulo_ubicacion" formControlName="longitud"
                    (input)="onInput()" [(ngModel)]="ubicacionForm.longitud" [value]="ubicacionForm.longitud" readonly>
                </div>
              </div>
            </div>
          </div>
          <div id="Contacto" *ngFor="let contactoForm of contactoFormularios; let i = index">
            <div id="CollapseContacto" [class.collapse]="!contactoCollapse">
              <div class="col mt-3">
                <!--  -->
              </div>
              <div class="row"
                style="border-radius: 13px; background-color: rgb(246, 243, 243);  border: 2px solid #33CD56;">
                <div class="form-group col-md-12">
                  <div class="form-row">
                    <div class="form-group col-md-12 mt-2" align="right">
                      <button class="btn  btn-danger btn-sm" (click)="eliminarContacto(i, 1)">
                        X
                      </button>
                    </div>
                    <div class="form-group col-md-3 mt-2">
                      <label for="titulo_contacto">TÍTULO DE CONTACTO</label>
                      <input type="text" class="form-control" id="titulo_contacto" formControlName="titulo_contacto"
                        (input)="onInput()"
                        [ngClass]="onFieldError('titulo_contacto') + ' ' + onFieldRequired('titulo_contacto')"
                        [value]="contactoForm.titulo_contacto" (ngModelChange)="actualizarContacto($event, 1, i)">
                    </div>
                    <div class="form-group col-md-3 mt-2">
                      <label for="nombres_contacto">NOMBRE</label>
                      <input type="text" class="form-control" id="nombres_contacto" formControlName="nombres_contacto"
                        (input)="onInput()" [value]="contactoForm.nombres_contacto"
                        (ngModelChange)="actualizarContacto($event, 2,  i)">
                    </div>
                    <div class="form-group col-md-3 mt-2">
                      <label for="apellido_contacto">APELLIDO PATERNO</label>
                      <input type="text" class="form-control" id="apellido_contacto" formControlName="apellido_contacto"
                        (input)="onInput()" [value]="contactoForm.apellido_contacto"
                        (ngModelChange)="actualizarContacto($event, 3 , i)">
                    </div>
                    <div class="form-group col-md-3 mt-2">
                      <label for="apellido2_contacto">APELLIDO MATERNO</label>
                      <input type="text" class="form-control" id="apellido2_contacto"
                        formControlName="apellido2_contacto" (input)="onInput()"
                        [value]="contactoForm.apellido2_contacto" (ngModelChange)="actualizarContacto($event, 4, i)">
                    </div>
                    <div class="form-group col-md-3 mt-2">
                      <label for="telefono_contacto">TELÉFONO CONTACTO</label>
                      <input type="text" class="form-control" id="telefono_contacto" formControlName="telefono_contacto"
                        (input)="onInput()" [value]="contactoForm.telefono_contacto"
                        (ngModelChange)="actualizarContacto($event,5 , i)">
                    </div>
                    <div class="form-group col-md-3 mt-2">
                      <label for="celular_contacto">CELULAR DE CONTACTO</label>
                      <input type="text" class="form-control" id="celular_contacto" formControlName="celular_contacto"
                        (input)="onInput()" [value]="contactoForm.celular_contacto"
                        (ngModelChange)="actualizarContacto($event, 6 , i)">
                    </div>
                    <div class="form-group col-md-6 mt-2">
                      <label for="direccion_contacto">DIRECCIÓN DE CONTACTO</label>
                      <input type="text" class="form-control" id="direccion_contacto"
                        formControlName="direccion_contacto" (input)="onInput()"
                        [value]="contactoForm.direccion_contacto" (ngModelChange)="actualizarContacto($event, 7,  i)">
                    </div>
                    <div class="form-group col-md-12 mt-2 text-center">
                      <button class="btn btn-warning " (click)="openModalUbicacion(seleccionarUbicacion, i, 1)"> Agregar
                        Ubicación </button>
                    </div>


                  </div>
                </div>
                <!-- <label>CONTACTOS</label> -->
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    <ng-template #seleccionarUbicacion>
      <app-comercial-ciclo-vendas-cotacoes-precadastro-modal-ubicacion-contacto
        (latLngChanged)="changeLatitudLongitud($event)" (fecharModal)="onFecharModal($event)"
         [index]="this.indice" [latitud] ="this.latitud"  [longitud] ="this.longitud" [tipo]= this.tipo_peticion
         
         [latitud_inicial] = "this.latitud_inicial" [longitud_inicial] = "this.longitud_inicial">
      </app-comercial-ciclo-vendas-cotacoes-precadastro-modal-ubicacion-contacto>
    </ng-template>
    <ng-template #seleccionarDireccion>
      <app-comercial-ciclo-vendas-cotacoes-precadastro-modal-ubicacion-contacto
        (latLngChanged)="changeLatitudLongitud($event)" (fecharModal)="onFecharModal($event)"
         [index]="this.indice" [latitud] ="this.latitud"  [longitud] ="this.longitud" [tipo]= this.tipo_peticion
         [latitud_inicial] = "this.latitud_inicial" [longitud_inicial] = "this.longitud_inicial"
         >
      </app-comercial-ciclo-vendas-cotacoes-precadastro-modal-ubicacion-contacto>
    </ng-template>
  </div>
</app-body>